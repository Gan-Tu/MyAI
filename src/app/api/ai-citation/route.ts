// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

import { decrypt } from '@/lib/encryption';
import { getLanguageModel } from '@/lib/models';
import { checkRateLimit } from '@/lib/redis';
import { citationNeedsClassficationSchema } from '@/lib/schema';
import { LanguageModel, streamObject } from 'ai';
import { NextResponse } from 'next/server';

// Allow streaming responses up to 30 seconds
export const maxDuration = 30;

const systemPrompt = {
  "iv": "2f6aaeb5618000c1912970d6b0765e35",
  "content": "24287c4c95072a748eaf9f6e04440770ca74a49c5516353b5e918d1fe11b7f947f1fab104932e2d20b83cbc1120b3260eda55a3784612849eb93e78467ad463fa343bf530f7cd463217bd604e02d0b2dbd8016895534473b65eeff3124f8169b6259bf552022fa951793273659f6d915c00bafa59e8251b3c153ca16c690ca2dfadb79ac8d55203fe97982144b9b6e1efe77850a346481817e0d84166a9d360613dc61e66bd7fc43e99302e43fa4d56c0072fd15303820d4e82e0f84a2ed36187216b6611b3affe52898709ea2b3cd2590942eea2a7932c00dbee77ec1696ca3abbdaf1293dfc06286b29a4f769d2cb7044e1db16de19ab58aaf8aaec1554afcedd1373fe77a831a69b65443074a2a4af851179cb77dc7799144647dd797aaaacf8b2617b66ce4796481fe1d64419c3176f0859e0624c65d4ca3885a47d87856959b5731287525684a223dbd3ef950bb02b0eacff8619df196653cf575114c15e1789f9e09e6ac85dce6cdaa0c361e21fbbacdad0ea9764ec54aa58831b06b16894d5d2622342c06df573b9c44bb1ce0bbab1a7c7b7e2a9b7c9fe9fbdec5874d498c558aec7f8de1af09614e4cb9528894c7f9039f9e99976ea84b49423daf3508c735350d85f5a6b6501fd545953d7dd4de2ced91adbc598bedd6024ca9aabdc084d71e364a15c0547911faf140c2c16a04b31c6809703f45f29e8890d96c4c1d364b0855d38e5515ec48875166ddbed970170414b43dd0999b8940c44a016b73ffdf7884e1625a3f9a46f9ff51d04e82d794c0833ac5abd4428696df378b064d176360797ae7664c4148ad9b72986401c5bc65d8bdffe782d8c475bf227f1f515fd3d3e2f3d19d82082cb3d30b9c8c59770251f05a72214e72015be6641f2a491f2e6a829cd3772716fd3f0f81a0ead1bddf5d17d7409bed098882292ddbd1e26af0a5e14f9cc0be55ae1a093c321a6bec5a47f88dda3af316def1995693717eac054f1ae90247514d28311e9468f5c60dc4b5f6c57e6a42232f79630113d1885ed1efc95569b80ccdb145b5ba472305a84c9f98c3cdca511b63fb20ce95ad8dfa56e97dac31435bc1e2b9bb6c674666b71914e0e4a938d8ae075e572303ff787f2922788e7ba7f8777d2689f94798320bb025eca35e3137f4d256c7695fb70c63cb27fa29127e5b70d79f7806df0906e4be9add840949b0225910f85e63e0ac43a8a5ead5c7c0f6cdaf00955ef9bcd45e0a594959f7b279899cf33583d6a95aec01f09c5efedc0dad36350cc7b605e2e111cc0f7a9640461f318c17324d1ecd0439ab1ef5f6f311de963f4686e53dee117b7f4a25e2329f4fe71a8d85591bbce1f210c75d81e90ffc65bf438816c9bb3c95599f1e1778f11f983d88b0522044473d6b31df52f9a2a7e97a6058936006a2504236ccaa6b76fec9a1e30519c6646a12837412df415f97bd1b4a6ab1007439e864c00d6035c82378b9dc05f2b99442d2667192aecb73d6b70d4c4f6d694f1b1753052c12b85db696279ec88c09cc249c494e0689e4cead10f38e352453dab4743cea756bdaacad145722ab3954309587918f9c88376f0622bcbf5f6b5d1c5b583ed07260061c48e52cde33654ce9f22bcf169d1f8819e47e66aa6d0189a4313802096a2fb6d7b8ca37b20c0f4eff51abbe43e6affad42755f391abd85e7825651f637e3cbf4fa8cc24466638ff1fad214c0a2648a663635e1340f960c8e2272f4d6cf0463afd8670fa918f1a54ce6db960c32b3354005eab319ba5339308c86dbf7cdbe89993309ce2b4b2c07a55273cb35deee329dff00baf4da688c06902728f00a18ff6706c94494b18739498e0766af30a6e409d2509ff41521b233905b9a25cc5a8b4952f7d55986032e841b9cbd777c0aeaaf2e82b49b1e2ef1aba7dafb7be588e4e668c5913579f6140ff22bba637bb9d1a94c735d9cd4006e78a2cb132769e22f5ce2cc05b18be8c3500522c180b8e6d79541a59abbecdf079b89236fcee1cd4a7d028b318642a0e1175e1115f1973c57b91e15b24b3450dfef5095ad25ee89edc1a2c6c5a99bc78d985fa5821e669c6834bfe83130e1e014778f0c9090bf9aa7e58f9cf61c29d648a9974c07b3c0d77d51699a4b1a50c1559b04dc453dd7a505b07635bcb8bc66682190b33773ca3d564d653be4372de8712b5b005d86573d741ae46bffc04a6b521cbb19e5d0d3974c494b3573a972e9af3b243686719a0d0849b901d3e26070202869d4dd583abac6ea4d53135b0740bd93db3811b2f9580f1d9ece11ceb129e877df7d5fe3d0a751cca1b4f02964efd873f8471df2f2c6733cfa79d2b994452e768194b2ba9ea8e9645f0fb305bc5d43ce4b171aac7c70f13c35766df507d913b6ac3b518332f9b9f45c6d0c5bfaec0d2e81c3f2ac48e53abf032e3dd41751e5f4f3b3d7e1fed6269df27f047a5e33531c7642bacdda38950fff6147fe462a80f25bb87183d9d651ffe8e775aed099662e978f358767f15846c9349c07c7d859c901bb92d7c4148267db10764b70a48a954e1fa132c50318c5c311a52f3ef66499430ef504e5889ed557ab82f11402166c875d2830cf8987fdf00d836a8c99102d9384a13c88c363f8ce624a3dad3fae589d08f284bf9010ea7634c27d5fb347c60dd95ccb84f4d9278d6ece0743b3f5fdfaad8b729e4e360ac9a6b54a61f6749406f34b6887f309cf25e1dc343e3b9e0ea237ab4488a2d90899658edebd5e1b9edb49faae988e626f374cb0de6a18dbe8300fe9d817bc9a7966472cf3fe16eeed767a4786ad15956e901675c173e36d2db83fe21713bf2f2151cbfae6d9badefc4e273ebee7c16650f60f2d875f44e987042ebaa26416c45f948d267885b9f01b75b5e6e0743e3bbeecff38c1eb2d9b89026fed544ac857c64ad66e6c200e7652e6bc129319484846e95caf84b18e403ab1c30bf403864442bc08674fb7c2c3519196ca964943b891f7a5dc64f9481e659d4653636d00c6e9d78b0372f8e978dae4ee3bed42274a407b2b919bb69e8cbce480348f9f2539be04473dbce625a0f5d7a0422b937b0707b4b62a0c0bbeac9c293a3f638326284977fddc8408c021ad7a9a2dc9d0e66e449ae9bdc6520b3b1fdc760e265763f40c623ba28ef0019d1e407ffb93efd2af88e58378f6b27b042874dca4cd7e4b2ff0f50f28464d1f3e142b62dea37e2ae9e14c9e4e27ca745cb3c4023c1f72ff12fba088d4a686f42f07ccae16e71d099f9fecb4a0c693310af7626d533a17f5ef1e5194c3633f1be62a7870fdfecf39c0fc8970479a03e784d2a42e0d32a21d3f20de0201d7c28bc965a2e52509473e4b50f5cd5e38a66d41c28092a06cfcdd09ace880c0012215a1838e0fa05bf8bf93b0afd825899c45b0b87ba3f655724fe7647463fd38a1a890f684f3dd8f451c907d3253ef17705cdb56c716b65c887b73cd3030bfafc85ce95fdb4238c8a22168014c986f5be19baff634f52c85fc3fc8e0d64c1b2d0b5d24266e76125a9d8b5a542d1f58a1a9c4086a7aa8b48a5b6616e342595209513c94f7e3200fcf5628807084320b65a1d4df79b65a9e0f5d4f1f31de40860b8c0e094e6d9a9ee74187f5fb92a1229c5eec8a33b98b37b667f8cbe0144eafca70ce47004011c218203573720f00c5328984a36ae7584d9ff3cdbfc0942f1f4e724378fc1ede36b77bee6d1da582eb60217eb71b0e34c977a6e88267d394a609699546514c2d78dc2d0126fdd943ca8e48e82dfbf250850d94037d3e8683b7b1b69cd2df08dcdbfb1dcd41fc9f0ac69008c3b5ed9d5ebeefc84c3f288cca6d18c8e96f6ffa587ae36fadaa5d9da1390368677ca2276ee8bfa1d3616461d4e4435f2b0d5f16acd0705c4401853c1ba1b1f431da400f785ba773b319c907c8421093405f56a1930e6e26ac6698ce35f41e2e9cb6afaa412745ac7882c8e0845ad9017a75561e324b2a764b8d4cb126bc5b371f819358af05dabac9b13117b261b17b8899f7d7133a8e76113174698ecf98d81c2006feb40ad5630d4efd37b925c048b4a0fe6bb174ffd323453355fe156e5d2f265107dba6617f27ebea9c2674dd260fc889d0370ad3e6003bb9c8edbb4f8cd6c8832e0453382fa9ee61bbd0f81ffe882ef6d25cba1dd41ae4df9250f9d45327d4d0567bba48b1261a7c6aecb24feb6eee039ce7bbec3d574042cc0b3b0406c386c54f93541c3e46d354069480a75848f1ee9a127c02bf564004fa4b383a6eab8b9ef86452047afe0fedc65d3e937c3e8f26cfb6e2ff394093990abf074c1962d9231f13f7727b9b6216d96cba745cd6b970a090539779861b16a717a837143ea551f770d3bffc55ecca2827b9722efce304c617be9e82c63d5cf789f8256f965a394d019e18f8c6d49787f27c121c1530513f8f35500a9d527eb5b661a76c74057d241b2d25b2cfd6bb698230e21e7069661ae440984b6ac7f5aa958694a5e47be6bc2f8a780496c93592b6d308295e127899a08898d5b37196888584906c918d32c61c8a3b75b48e73d71cadf9675661aa131091dc4f304375825126cadf54f61c785d5c28ec2cb492b1ed76e34a67eb25288587241c89d0e25c5821aea56631046eaebf00852761eb5e666d6652bb87dec0610b7ff02afdde91ec4d11cebdac564df5c4a60c8a96b7131481100000ddc322f5a85d3e2f21edd3ed83e72a5f2518578cb03fc9abd3862562bd0f7019d74a8e7bbf981292d9f4eebf9d57d2f6daec3e357994b8654402b11ea79c8b53ec5a3a43567664ce037f6055ae7b3a5ff3f3f436f8eff77c559f0429e3c5d5f2837c3e77b7b70ae02ec10ff48a111b31331475b748f24bda6d800f3531a40a0bc3c07f306a55d38a935de8b02809ec61a517eef935ad58a4672451f62623065af1bd7621bc5e8762a7517e1ad671454dba991078b8d7b6c98aba3fb24017027b7b785bcd441abe5c08c91a65ed53ec733bd53b9d2ad06ef16f0485cef32ee2aeca7fdd3c7ad09b8474b768ad273c9031cb36b74d4bac219f81ba98999dbc223d612a15c88db1a29f1a5e945afd5948dc2ce98530a4df97e280e36e28fa4c21fc9ed2e0a57e771f745d6e2678e8d799780d42ce68edbb1f261fefb86a68a44977274609e50d14d443d29b4a1443149c0bca664b669f8fb7bf62583168d756047db85b441021905a447a77bc763da5b84c6966e7eaa2a244e5837eb3a570bc9f49ad9908f37e7d4b20168f07d0275d6c599de3496e3df11e54c2948eb7d43386c8bda639f4da3782744cdc61f573288bac4d68b1119cd312953218feb9dfdf194c0e223d3ddf1a45ef62bb548f21678c0491ecf59e133d070a9a0314717a57668f6d64a2965b5cb652e7764c70eb01df45f14bb44c8221d42bcdb8482e73f4c4f7936bac5e26a6cc8e3ee8d5479b7d07c1efac47c2b201877e44e995f1713c654838c3bfcec9e3996a2357e9fbd1e1c9894cbb2264c78ebab5c4a3b6267164fcd2ac8050b85faaa92c7d5bbabfcd180fa2a2f3d4064a0feab93b8a7f0a114b660c99ba9315b7fe44af1dc47dfd38bf6371e2ab1ad3b8acf9ad9112f8724bcf06aeddd46879fc0c3a5d0209437e5b189e6b74038ca8f27a4366d9fb913cc6eaebfbe1b277be501fa8b57944a33ef560cc80c30f8a7f682dc6e951e2b9f6f4542190e5a151e7ddf6738294879b827a6f0bc20e91c28cff49306ba4c9ede8aeec1133b57758e1e368d4d42d10179bb1644078d7c07bd451e0c0d3e4aa978eeb9fcd298d9dd1fb5cb5934a3bc58a8214b1e63c4bfea81cf5bfc964a240dc2cd9c766c4e44743af7ee01e7ae8762382c647b4a21bcf92c36dec50cc83167546ca17ba8b1ea0fafc29b58d56fe726ed4da81c648b25abe3136397a032e77725a9ee78ca784495f56a7ccf74ddf55c51dcba94b9e68496979863d6a797db72e475abfac6fa3c6eb0dc949ecf4daf0dafd29fca316bc4a2cb9347fe8730ca98b98c2b089e0a23e9b839392dc254d78c28bae0df45ced33b5081f69504c010129a374ca1a4cae184b1f26cca2e2f8867af9abd94cdf004c8e99d2f8bec602ad4f1a15ef00ac364527282e594d9fa3c66c2fbff322d898a0864758eee06aac58a12adffdca12ee238fc2571316f29788e798e20c88abed78193ec64be64187a5bb8f7fe1b40e06c99755a92255b1f7be393a3695e9cc7b836fa574eb3a5d490b703c3198160fb7e14fa357bf80109c73eb0c816e179785b23da62830d0287599a32e00c1a5a5129f779b3a30dbdb0502e8b118ad521af1a8908fe975ed33debe690e75973757251915d502a88fc3e33d14a20b927a7b4dbc25d8ca29d87651b33f046ad9b14f546b8ef2aabebe253743e1600c16e937bd7c8648948b94ea2333563ab4cc5d11606f0847109042007556dd430fd700bd92cbeb4288500fc730cf1bc862b5d146bb07e5594b6ee6a491d51a7e19739efb1e6322236fd48c91a4cc4103e441aea9516e7f3bd5e24e6ff0212d69e63d84a1aadc1466b0886adf8ffff78f86e4d50ef0a23e5f41cdf38eed6926d59b5ba63b105d97dd4d97409181b06d2546b788afb9ef439c6363bdffcb85fbff124557052f102b19d0e3a81246de5a8a0cd969622775928aa8c18908f50b0a431745e12e466a44030aee30600a6d2fe71de459bc605e9b703922731438e1d047d1ab7d2b69d452e1794111d024e46cac9df92b7cad788504b0cca18fb3cd65010f25cdcbba046d8429492e7463e2b0f53f0b7b20c852c0a0d35d7cb0fa6ed9850538692124edca5e0a1b043232e4487ab4fdecf2bbc45032f1cf38e82c8315cd0aef9d3c803d2a2e12bc647cca4d17ff35e2114b4cc820074c3216980a54acd25700c3e1791cf95cccd74fc058b7d14709f8f0240b85392892738507dac0051964092836fdab5a3b5a6d8a709893a33363e0fd0d3da2e91f86d2a1ec47d3eafdd1ecab8683daa28f229f1848ca5ad6603fbec5114a10e22b729872ff6d9f2cee1e71b5c59f990652434cac90eb9a5f021a754c935f6be07b6f98681a6155bca4670d27757d89f4a7a020f7b9dc91d24860b49466fe498b4eb0673d1a68b85700cdda9a6696deff429721d6bb893bf4e3a30808af3e7e9dfc1f4847c28fd5d4a3bceec9f0165b4fb9452b109f613cf74f294684c575d100b48bf8cb9f7ce075803a82fb1cb4f16bd0e895c8bdf81a1799a666a84415da17ba725d0ca033fbf2edf961d25c289fc0d884ca780ce7a6d4bbab03c62776c05353c7fdb15095288c19706fb9b07f36794eccb9c558ff7d561877922120cff34b6a6fe497d5b3ecaf5638479a734ac2bc91bbad87eb6a7728bc0103c37be1f0445b7149829618a163124805d89ef64943b126fd68197b64c71e43f8f9dcada49d8cc1696bcde13630e42bc4f3bd92484fd206eaea3f8ee622bfd4f03bb991486a9fca39f35c341af75df109f386d003192803790b81305988ba86c6647049daf441964cf1b2164beeba2858736b41d8fb4f2822f37235286fa0f130fa92e9ced57c575f14e58ae5f3403f69ca1a75ee55702addcc3a583b692ebebd9312b107b50abf348902381199d8ad77ce65720f40709f78ac66527c6ac35a64dffb2d380ce1ec6676949302aef8a10b83fb512c3ee664319b847e50088aa5ddbf819c116eca0b27aaf5b3124e71f82914a38b6ac40776559472e79574b663a3a28dcf90a3d9ae83d8ee7b936e9326e40ac47354911b476617c30b5e993ac8345e499610bdfd6cf2e6d77be95d0db4bc063af1a999a738ef30a1613ab5edab4b375358c8b5f03e7e8924f583a6ea2dcf726cbeffe9b5fd41fa78a4e3793ada0b430c6af5c3bd80cb6a99ee870c3f223dcefce05f9aeab13229e3911ccf52a46ba8b7bc1ceae0c14b8"
}

export async function POST(req: Request) {
  const context = await req.json();
  const headers = req.headers;
  const modelChoice = headers.get('X-AI-Model') || 'gpt-4o-mini'

  let { passed, secondsLeft } = await checkRateLimit("/api/ai-citation")
  if (!passed) {
    return NextResponse.json({
      error: `Rate Limited. ${secondsLeft && `${secondsLeft}s left`}.`
    }, { status: 429 })
  }

  let model: LanguageModel | null = null;
  try {
    model = getLanguageModel(modelChoice)
  } catch (error) {
    console.error(error)
    return NextResponse.json({ error: (error as Error).message }, { status: 400 })
  }

  const result = await streamObject({
    model: model,
    schema: citationNeedsClassficationSchema,
    system: decrypt(systemPrompt, process.env.PROMPT_SECRET!).trim(),
    prompt: context.trim(),
  })
  return result.toTextStreamResponse();
}