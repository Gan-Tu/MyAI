// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

import { decrypt } from '@/lib/encryption';
import { defaultLanguageModel } from '@/lib/models';
import { checkRateLimit } from '@/lib/redis';
import { claimsSchema } from '@/lib/schema';
import { streamObject } from 'ai';
import { NextResponse } from 'next/server';

// Allow streaming responses up to 30 seconds
export const maxDuration = 30;

const systemPrompt = {
  "iv": "86ec7942ee149e209af35be3674d270d",
  "content": "e61a0b88c6ff091c9a652049a8c545bbccc9d65fe7e33275a10b009fb7f67dc62dfe291fa56dd935fda88b2047628fc1f1863691979b2c3a712371f62f85d3cf46dcef8337ce6e24fa9c6620e28911cb40ad3fb1fdf9e34fb416c882454fc3a5c329baa5717110ca2f3b2bae95678173b0a9bb5d9dea1dcc1dab5771b812db1c8f3d67a01d036522afc727a566e6c5b0921969e4e2684b2fa2ecd23e8ee62cbd8fe4a8bc4cd4df474cc846249d3a08e7a0fd0c9c9662bb311dc644272515aabb1a92b188bbb352a9e39b4344b5e71249908d148561ffc2edfaa193dce359fc46a5c3466d33ced1eb8da6f05c583acb0fd0b3035177fded9c705dab87fc73adf497b7aedca717f2f95cd05248b4bd45473b8417abbec9dacaf103a8bb27b9b2185be2f1c567c073ce2babe58b6ca04c6218f87fa476d7e640df15bbef390e6861ba1f5fbd4b2e2220eac2dafb0fb332ef7648559b1ae2745d73b719fe113e72c86477e86692e3c50da7f8f5fd84a3c8e0d6a61aee19bc4e74020a40e81e1de9f3830f69e5144124a3fdb88aa76ea8c7fcdd2fb22bb0c2ad767742e7710c7305a073622a893b9b7980b68851bc3cf0089b16f4b17e749843d7eec81f3ed417995d02bd6a4527b74cbdfa5e69902ad7fc9f2e462fe83b39189468eeca1bd9813625c5c1933101e41e15854304203f82651872657b5b84cbf4446035b358a50438fc153a3d79672372872719df43fd9f6f5cad9899130867c03080291e7a1952af5ba33c2316ce8464e1c3fa9015719d3ee54ef2e963cde219dcebd7eebb738cbbe77de6677f9dd1978fce140f913ad94e9bfd0d28069a811a000062a9019ca06bcb03319165a906c6774d9fcda8a0a7e4c7e8ad8f8ee003d7f7d03da1516e5edb48d8ec68b15fa7ea34409953ca0631e1bee796a978e80f1338d6e841c4b99dc930ff1ede0d7239251a4e8faa3703ab124aece45ed3033ee350808617b0e2fe8099c185bbdd717b413eb756454036222ba31d3f0ab24a98ba2f718b8db9912784ef4fc2a1a3b5dee7d90a8d7bcc7acb337af6545f63b35d4557f29be15a2b439f8684e929bcd61d525caf19c2c0e7b6dd17c10f2cef3bc6893f1c537a7af3c9fb8060aa16b514b8925064d0a5a5bd4f44ee916882f753a7f998ee07a892b5909df797608f129fdcbdfdb720c8fc5d9a16c1691a1e9da5fb12dd655b28e0c600443e9917e55f78d9caa1392591020740eaa389cffaa0c31422c62bb009c71166dd3182660ada6d8422c7d85c51b7786f6729e3d3ca7cb421a5b008232a7b8ad8f20bf85eff0906c6f2e35053bb53c386b63c5a72f19336e19db648e4eff3ca445b725a6bfd50b96fa9eaf47332dfa38d3a378ce7a45ea6980a4788906ab54073279348a7422828cf33e5010665c34b9c8c76b2592f6a80415d9dc78db651eb77baa078f1b88779f47dc84898f222e7d26ed8b1d0b3ba4e291c196f755019e342c15fa92dc59389cd5aadb40447d486a2cda1b3ceecef0d54d92b50ad9b85dbb15b9829cb73db42e93e07b39fc1eb97f1c47e8117aaa0f293820eaabea91375c449d330fb72ab8a0c66d8b6c8e248a89d37d0aec8b15557503eeb5634919e97638915a06ee6db001c9fe84c736e8af0e6751aeda47157738f5c5786165ba23fd1d0320bf51f69fbb72ab4b2b31376f3ae8ce62b58536d95f173da67c62244d5eba2a574207dc83baa607a72d42c8a0c8a95fe5fa6ec3b6f716bf3b0e8d6766cd9e1a30960fd4a5006847bfee79de8690bf52b8048d4c5d4d835eafa6d09227560fe6e5e187ec7508e0a3b3181141a526268b385d86fc90785fe889a60a83c1445cdd26071401094202f918291af32572fe248356043f3c85a29c9a9905a2c4100dd81df780d18f04d42648929180aa738904ca23267befb397957b07339ef47f35bb38c3532e2aa38abd4b22731acd27b92c542b27f9a48db9984ef2992705a2ca53829277d530a98e19722924302cf1af88c238e402f2ba0fe4ac2fdfd11c04719b48a429c52b999b6abe1ae014c96642a66587cd67a32fa9bb8057aca62b70260907445a5c8a47e95caa08a833f596ddd3aef1478ba2c3e760e87967def36357351a7e71308f190f6720f04b8b4e8c91cb1cf4653b7c945b29a59ade79abd19c1953965f6e6b7dbd5294bc06622a1689a5fe92471bc0bc7a5f0129ef7fb3fd896a1c308f0866501ce7b1ae2f8104f375a9063551c8b1a088d330bf899b1f7747e327f8a1895dc6f223600aca64ec0ab3659d6c407db33a64eeb04747fe0ba493691dffdf3c83d6aa03a39458fee7108de53ff349b9b0590ff51e69d096bce9a2209c548ec472a2354adf04f331874b579cc6beaeaa8f55c060431b0245dc6814332a160027230437e4a15b07a0063c2e9ea8d826c93c065c390d5c4d5c77b6a398c0b4643de230f4801977b1b45555eba439efcb3532c9569a0393a9796a367f5ef8f4f63f51e05e529987be93324c2441d3b9dcc76c22166d5976f22765658327ab874e73831803bcf3e08ea8cb09d2970891756e08885497060b22e9cf7725582a4baf2d6f459aba20d750886b7c958b805c92ec6b21004378faa07a7e37245a0520fd7e45074c28e0a6e5487b02d026697fa76085b57ee8e1891f55f4a1f91977a920b11aff17e1efcc1215e85fb2fab0ab0f25b0c26856ad01b7fbdebbcde40a621056de5adeb3f0f1074d499dd3cd470e95818dfec5e9c428525ca9efa89c632972f90307d8292e3ea374c40adccdcd2a5cfcd212bcd5b74966b8d8e88b34085320da4b26b28b24e43b526bfbdc44735d21d709d9632602effcd03220fe18c89736dbc281622ed08789fabbaac9c766598e30f6bedf6145ec77eda0da6fdd96347c3093d002e64ec807ac20687a86addf7dcc3765681d43a5c4259a8cd2bebec29a0333bf4da5c106810f780cceb05741290ed0d1554638836576e6fb404f0ec208d8901312504ff7b1a318309bed36ead9fe79de078137824b007ca84c3a1bd09436d76051db3f34a0b5dc602b617b28bc28997c77b7168e926dbe473c2078fe52d77403b8f1b21d0f3a1ea7d85438fbbff54f38dcb0bea5ad8ae7c25a4aa1e86138fbe4784a89885704736a44ea0e3a219c994a98cc9a95ad7c7dd18fd4b3d99212e931d1e59510a831a26b04a26d228deb488c2c8c8c391cf7e871a0f2730eebc520823892ebcf25d733722fc7ae68e8c4b117a72dac570f1f4c9f5dcb2d99c5bcbcc982d3cac4621c72408f87e929b05736a10d93132936802f945fde427beb32126385ad2bbc7962601a639c0450b3b2714d4f4eed47054a94b59d3b2b3f92d7cb82c17cfe72c1b66121d54b88acf4a3fb6914f3e8be8f54b524a99f3c38a7e939ad04f8eb721770a2b4e6fe680f8c888224e9b0541eb119ae0f2e9d4bf3e014eadaa015702086f28f008ab1da3c25a388f39dc4098beafbee0a0ae2f1f41e6379d7c73aba3d9343c7d56aa86eeff5dd7cb9d49f044371e7e1dbc15beddda97c707629b586122560a464adcec0f8cce17a98053b6d9ea63322f6bc0e3f3939e0702efefb542c6b0af813b23c1f04099180819414fc8f325865061b1339035b5a7f9d54889d449549aa784e53d9e61deca5e08e31be204779c1daa1f5cfb16274b8a79babf7578208560af20c382b1f2cb19d6d521465ba36f33f13cdab9089bc1e1aaff4cf2c2288903100928748420ffbdff43aaed12f08fa294add4dc063ae4c110b9cbfc49af122448eec1d539b7c2ae9bc7e16d72c9b068171307d770d0e673be181959e47fb20fb36c43deade57233c8f28c3d05d3a358b420b8eb9e6e27f34d8e017177cdcc2366eda694ed8daffb08e3b5a70ec4eda6109027d951adc8b26cc19d668a58dc42c3c248528900f0acc5590e8fd6bcafd652f52040b294255c1326122a01f2deed1da7bb17f56d211eac4837d77a2f6c6c4cfcd41bd3c7b604075eece2722ed0437ae80ff7024c6d4a98394775d148970633975e2ce561eacdbe3c4c083313e36964afcbdd0243f33247e838bf68240586b1382cc5e39167fe815091b156a47248dd6af9e4704be4ae784a42f2e335ddf83466041614014c8317676994b44a6fe080534b21d7eb2b44975b52f4f7779c7ae35e4671a26e8e85ce77cd0ff465c635dcfe7fd0e4330eff1b9de9264c6a6c699b0463e17413bb1e427f387ec6603d9037af2d23af4f1f4605ba44a761500753516dfbdf71448a8e18ccd1be8e213cea1db7de7b6fea37e0fbea277af14b7748458409cb6afc39e3bbeded881e661b0cce7798e366a82074d65b0c2bcc648a3e3325ec7ec9ba6aa1dc76af43f0cee9df18ddeee13f22ace7d1eb7c12c2150ea5487112525c600a4d9da86518e27873e4f0d1b3fcf637d229b888a3e402b37a12c153612ebdf0edc78692dd93a77634e9a81fc22ae9d4558393c4c1103f13d7207ffbdaf2ced5394c5b8636235fb5a4664a729acdd914ab009ae0e14c138f349b6cbf3d61ec10b8ca70ebea87b033f078d00be0266872015acda1fc1a3a3748976e4ed9a6185e5e8c157c2eb1cbb12b2adcbbabf2b38164fc583489f39c11ede0af094e040bedf47f7e73d701d1db4d303702461b4dffd7770712a1491b0ce088a4fd223c4b670bad6047ba9922183569ec20062a2c003eabec8af972e335578c5e01d3dfb611e30d09d81288a9883c9dd9994a258f42ea6bc031c564d34d3fdaeb1c8d50c0b8a9f3a3ba4c29b48b1513b96f9e84cc549e873de3496b5182c6d2e6177f57b7e330888ff17df9e1ad99d6dc08f2486470025f7eb6fc61784dad8abec95d4b3b2cff7808a2fab1ece7133dc25e3a9692232d87a5246696b80258ffc7d983ee0f10741ead6f107cccab07897399e946d8109d095a46ac52a941ce739aa0031c827c511cab23d1fdc9d80ce51660ec42c5ca4ea71bd6507813f1146c4c3e235219c097754597e70fada01bfe48424a1c6b9a7bee550680ec79e196306b1e5d512045bdb8e2a14897ad4698748fb0ce3c9a97513d2134d0360af5c39eba110a5fdd6b489df341e81a14a57bb214dc7a71aef3d4babdf3dbefcde70bca494e1fe81f979ba53b4d1d65a21961a6fc69b40985860440f49d9fb4342d58523a69789852d17446d892682b826e950248f6612ce4a7848e30165854e0c09460a41d8a9a799a7dba096d0651fe623ad488d6f7fef253a3b2954a5a77984b356f43b2d348ba9e5b08f9037cc6a26ffb7ccb99b426c5fe080e70bbdf67bd011ca9f51a3e329e1ce84102caa35cf142b81bc32da73fab421f2450cb0433756b66b7bc77bee580f7807762d739994cda191c71d3b058edc3113abd93d2a6f8bc64d9dfa58aaa4ae78b8608313214f8ecc680e85477425760e944ef58ca5c07da0f78ad0a3e2d00baedac78b9bb616a3a5b19ec8203ef3f8e1fb6eca838fbad98660c872ad194ba5b2bb530f3670f930f58dcb677b051b6f4cf01b6c5b43e94af81a2f877f813e3c0f6a3b3decfb26ee4f61f8f130e9c51af0b20f5015bf7d7ade852b8cf74cbcc82ab6ec86894cad3ad946c1d5b293c5d14e4d4489f753bd4eea3e42a1708f3ce4e3dac63944f29fcd5aa0b433769cca4ae181e36c61571032487ca98ae94cec0942b07200b9320b7245d7b2fa99cf84e06dbc14f3f93895136f5b1f4bb32a1c03d253c94a2e171393596d240922f94eacee30b3779c746d2bd8ca74eaedf00427ae6a426738726365758ea57b61ae06f627d2416f2dcae9b02cef451aea242428d72594a63e5dd92126c22f5ff56b3e145925011536315a7fcba3001eda19f20854ea0abf757fa6df97998557ef38a40ee8c09969af5dcc828b508cd8fd67b20650d68a2bb0949f9220cba1809943c3e0acd3af790ca7e174c7c31700d23a702e4023e75493daa8ee0eb8a9392c667de335f4366fcddd0f80909f9c6b422bcb9dbc1f183d4f379f4b1f21ec40008e3f0d31c3dfa38f4e91eeb3569e0cd0365afdf34e3bc02fb4e235fc0a46e3fbab836e9edd1b214e274f2d97ed4398d0ba4b631b50589d5956f683ab598d7a134636bf83cddc8711487a536d6e2355fb4012081c513b6f2631f67ac364d2671fcc8db763966b05c8779aaf4b3937b902e8761693bcdfcddc307975dcced3fdbd598fef6ce8eae34d0acefebc2aa347f81e4684a7970c994da5a5bc8bece3b95a90477b5a585d7e79d6609d97848c44e6c370a63670f774c8d81d77f29d5083966a1d9860b1d7b8d4b7185c8286c349fe840f903ee03e6333bd944bee07876eaa0d9cd75c0be98f2a55a9c1b06bf2d1b39301afb4ce9d2db7c2f4828c069d6e58a12cf1f47294e704419a7bc397843bc12268c71ea59323b90fa5b30e629365ad39790c3a41ab0f63fa56a9442e35652a6b401adc1f309efc9be65ebeb2c4738709e33427e58a204353af2eab56035011b332e076fa1256aebe482cd83cf7c41551a4d4a68465825eb9883785b16d43a7b705c2cc952e7a038e473d699fea61ff302db9c7c081e2304d00d96467198b197d88008c8bda0dbc66d20df399424c24dd7e8eba32837a40906b63289d3e37cea731e9bc7700ad968b278477b7f72c7076c6934e18d506edf7ae6cb06f0092e8aad1bfbd337d844433e7baad3f06bea30ba4e4ec7308d7310a73a88085b2bc8a70dc4585c6a0014a67a48ccee3e922b6fd23fc6354f252599fd63cc2a2c726932f193120254a53ed1770494813937ece3ec8536c1a745c0f72b5b9c06e805e3e8a9a472aefc5289d7d8256bc977b89b0a643e5827af39da33f628cab2516edde853bbf51b2297ad20d4a5e264a549faa4270a036d64e23d81af141940c75072909fa9e25720698c84d14b23496c045c5a60d23c075f00a1c212c9c887fc947abeddfabc50125769e86ca083d4ea8b1a8aa7f6c3cfca1609eba2b6a0aa426c77a7a0c87c2931d16468c4618d83b8c81ef999c564f15943190807021c5d4c6cbae58210f980b8e861d4967c5e5effd75b62e9dccaf4508a18f54cce14701eb3f8acea6a0c064f407975d7f1d4431c49e3496ba29015f552b54e63cc7ad553bf2e8e1e4c9412a3e87cc16348638a1f4062ccc14f914d5e265028a1c06ce421adac7b1ccd6ad6f8dbeae89378115a5ac0e158ff6cde78b013de44388e808f5eedbeb2036ec0ec7d08465f9c62b82c60458654da8c8011284c145ef6140e7329e17bea16c70e60f232427e10c9bfeb904c6de5bd6594c45cc8118a7912db4dade7eb88306f0dd340366b4338a3ab6340ddcbd923524a57475afe407d8e5e6bebfe9acbc6a9faeee5fb83c1ae75cc20d1a3060ab4227a324d8ba36c916be9a9461406529a4c51b88149c974c3a83ec8417a0c9d229e8c4724c50d5c498409047805863e1d99ddea9404755ce68c5ae021da862ddd69fa6898ccebd9059f12c6f107e71b9bacd66f97e64650388b0477656274b9b477fee2fc3156a039a5a06150f4ad2b9a9e4490899b95238ad8678163b81f1de4d95f203593827f92b31c66271edc635bf2ff8c913df66218e9cd6ec1bfd450d0ec1aa9781cf86ebf4bc0b3f2388b328f7ec086f813955d9a74eb9c370372ba58bd1fa9fcb70482d0398c9835d80dad3c378c99a1d1f9d4e6c50ba66c5d83555be1d6bd1cb339fb1a759e9c49fe87ebc7f9d0cdb315b4b9d9361999b2bb180af488a5ed238414ec1f0dce0caa49611154cc1996eca7622fc1a575b3ebf5cda01ecc2240da84845a94880207a772e5a66e9e7c505d36b331ea20c0924b8222f6295606c4adf5604feb63dfa6239b58df6d305b9782def5f511c1935fbd11272b329aa2e40ab83e7d67f908351b74f5b0799dc6a944e986f4e5a4e79807738ae12eb3694802fd2d2ed7eca33113b297c706ccb9ebc1f8f7bb1ac61078153b8b38b053f8c54c898b9c25952ac80929f8b4d6351ef4f3caa97541e87fd91c3cc17f69ab72a429c66f7af154e2bf89d149c16db581fd708a8e4c5da09a76410cee3de7d455b86637d9e3ef0aa08526cc80f7b354c696823eed3303356a8033dd2eae9626bf773d409a6aad32921a37097bffa60f32810b972037762510fe5c5520d9d6a8c728a97e30ed8ee24c29a8bc6cdc5113a063589539416aa2d0db0d833cff79a8eb5eeb04d93a9bf849ce79b77ee92cdcb46a6cd93d3fc134f4c9ca1f06960379e5b746ba48cf137e36a8e533d132f74998926c51a889a913ca8ec4ea7e134d621d6c33aff6a838a3a173c232c1dd10424215e1e3d3eeaaeef5685672760686ba417cd19ba287ff6da8b100dd38b30c4c83773d5d64fe180538a483a072a7c53b3a0c747af2db26a134c1106be1b52b46e39fa4dcab6759369ccda10d8befc7685bf3d91c696629ca082d0add27e8483e4e1ab4ca43d2b2abc7b65a7f536716469e25731275dad7cafad8ccd724d59e2fff67b337e7a0319db18726a95fbd7f4c331006ea2f11bb448cbc81aea562cb2e221a4f250603c4b96812b916f795bbc5381e5392d9da5b0374d0a8e9b13b826d26ca54342a74364a4ad233e6b9b5e714f3f0"
}

export async function POST(req: Request) {
  const context = await req.json();
  const headers = req.headers;
  const modelChoice = headers.get('X-AI-Model') || defaultLanguageModel

  let { passed, secondsLeft } = await checkRateLimit("/api/ai-claims")
  if (!passed) {
    return NextResponse.json({
      error: `Rate Limited. ${secondsLeft && `${secondsLeft}s left`}.`
    }, { status: 429 })
  }

  const result = streamObject({
    model: modelChoice,
    schema: claimsSchema,
    system: decrypt(systemPrompt, process.env.PROMPT_SECRET!).trim(),
    prompt: context.trim(),
  })
  return result.toTextStreamResponse();
}